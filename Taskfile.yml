version: "3"
  
dotenv: ['.env', '{{.ENV}}/.env.', '{{.HOME}}/.env']

tasks:
  default:
    desc: List all tasks and descriptions.
    cmds:
      - task --list-all

  build:
    desc: Builds both the scraper and server binaries.
    deps:
      - go:build:scraper
      - go:build:server
      - go:build:genswag

  test:
    desc: Runs go tests
    cmds:
      - go test github.com/ecshreve/jepp/...

  go:build:genswag:
    desc: Builds the genswag binary.
    generates:
      - bin/genswag
    sources:
      - cmd/genswag/*.go
    cmds:
      - go build -o bin/genswag github.com/ecshreve/jepp/cmd/genswag

  go:build:scraper:
    desc: Builds the scraper binary.
    generates:
      - bin/scrape
    sources:
      - cmd/scrape/*.go
      - pkg/scraper/*.go
      - pkg/models/*.go
      - pkg/utils/*.go
    cmds:
      - go build -o bin/scrape github.com/ecshreve/jepp/cmd/scrape

  go:build:server:
    desc: Builds the server binary.
    deps:
      - genswag
    generates:
      - bin/server
    sources:
      - pkg/**/*.go
      - cmd/server/main.go
    cmds:
      - go build -o bin/server github.com/ecshreve/jepp/cmd/server

  scrape:
    desc: Runs the scraper.
    deps:
      - go:build:scraper
    cmds:
      - bin/scrape

  serve:
    desc: Runs the server.
    deps:
      - go:build:server
    sources:
      - cmd/server/*
      - pkg/server/*
      - pkg/models/*
      - pkg/utils/*
    cmds:
      - bin/server

  genswag:
    desc: Generates swagger docs for the API.
    deps:
      - go:build:genswag
    generates:
      - cmd/server/swag.go
    sources:
      - cmd/genswag/*.go
    cmds:
      - bin/genswag
      - swag fmt -d cmd/server,pkg/server,pkg/models,pkg/utils
      - swag init -g swag.go -d cmd/server,pkg/server,pkg/models,pkg/utils

  docker:build:
    desc: Builds the docker image.
    deps:
      - go:build:server
    sources:
      - Dockerfile
      - docker-compose.yml
    cmds:
      - docker compose build

  docker:do:push:
    desc: Pushes the docker image to the digital ocean container registry.
    deps:
      - docker:build
    sources:
      - Dockerfile
      - docker-compose.yml
    cmds:
      - docker push registry.digitalocean.com/shreggie/jepp:custom

  docker:run:
    desc: Runs the docker image.
    deps:
      - docker:build
    sources:
      - Dockerfile
      - docker-compose.yml
    cmds:
      - docker compose up -d

  sql:dump:
    desc: Dumps the database to a file.
    cmds:
      - mysqldump -u ${DB_USER} -p${DB_PASS} -h ${DB_HOST} -P ${DB_PORT} --column-statistics=0 --databases jeppdb > dump.sql
      - gzip dump.sql